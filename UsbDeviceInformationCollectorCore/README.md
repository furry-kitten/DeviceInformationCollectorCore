[Вернуться на главную][mainreadme]

# Описание

Содержит в себе логику, позволяющую получить всю информацию о подключенных устройствах и реагировать на все подключаемые устройства, собирает все свойства[^1] в отдельные устройства[^2]. Позволяет быстро получить информацию об отдельном устройстве и обо всё, что подключено. Последняя функция на данный момент отрабатывает некорректно во время выполнения, но хорошо отрабатывает при первом запуске. Благодаря собственному кешу, позволяет подписаться на 3 события: добавление хаба, добавление нужного устройства, и другие устройства, которые позволяют реагировать на добавление, удаление, обновления устройства. Некоторые девайсы возвращают свой HardwareId (можно посмотреть в [примерах][example] какой считывается) необычным образом, который начинается на "SWD", данные свойства не считываются, но возможно будет добавлена такая возможность в дальнейшем.

> :bulb: _Возможно, можно будет в дальнейшем понимать лучше понимать, что к нам подключили, а точнее разбивать все устройства на телефоны, планшеты, все хабы объединять в один физический, если будет считывать то, что кидает нам устройство при подключении с учётом SWD._

Проект написан и использование ReactiveUI.Fody (18.3.1) и Newtonsoft.Json (13.0.1), для лолгирования используется NLog (5.0.4). (сейчас при наличае подобного логирования у главного проета, придётся удалить удалить метод ```ConfigNLog``` в классе утилите ```LogWorker``` этого решение)

Для корректной и полйной работы нужно создать класс конфигурации, в который нужно будет передать делегат ```WndProcDelegate``` и дескриптор окна (как его получить описано в [_"Получение дескриптора окна (HWND)"_][links]) и подписаться на события путём создания методj обработки, который будeт получать устройства/хаба[^3] и его статус. 

Сбор свойсв в устройство происходит по *DevicePath* (в данно решении оно называется **Path**), чтобы избежать ошибок при группировке используется пул устройств, в который сначала записываются все хабы за счёт которых простраивается **ShortPath**.
Короткий путь собирается путём получения id хаба и вычетом пути хаба из строки пути устройства, после чего из оставшейся строки достаются только числа и берётся только первое, что будет по итогу обозначать номер порта хаба. 

> :warning: _Некоторые устройства почему-то дублируют в пути последнее значение "USB(\d+)" (шаблон регулярного выражения) из-за чего простым сравнение не получается обойтись, если у нас есть хабы._

После группировки свойств в устройство (как описано выше) начинается вычленение минимальной информации: модель, номер модели, производитель com port. Модель берётся из свойства WPD поля FriendlyName, так как устройства типа телефонов и палншетов считаются виндой как WPD устройства. Из этого же класса берётся и номер модели из поля DeviceDescription (Description). COM port должен быть проставлен в одноимённом поле только в свойстве Modem.

> :warning: _Попрой происходит какой-то глюк, и порт проставляется для других классов. Это не ясно когда происходит, но на данный момент не используется для вывода минимальной информации._

> :warning: _Иногда с некоторыми устройствами бывает, что можель и ёё номер совпадают. Для решения такой проблемы используются свойства **USB** или **USBDevice**, из которых будут браться значение из поля BusReportedDeviceDesc_

# Описание классов

## Services
```CollectorUsbDiFacade``` наследник одноимённого интерфейса, реализовывает подписки и позволяет пробросить хук для отлавливания подключаемых устройств, также имеет метод, что вернёт все подключённые устройства, кроме хабов, если подписка оказалась неактуальной (в рамках решения нужно знать только список устройств в момент времени).

```DeviceManager``` выполняет сборку всех свойств, выделение и заполнение устройств. Все эти функции он выполняет за счёт своих зависимостей.

```DevicePool``` сохраняет все изменения всех устройств и пробрасывает события.

```DevicePropertiesAnalyzer``` получая пачку свойств, собирает сами устройства, также устанавливает короткий путь до устройства

```ExternalEventsTranslator``` отвечает за создание событий, которые будут буферизовать все события, что пробрасывает русерс окна, которые по истечении определённого времени будут запускать добавление или удаление устройства

```SafeDeviceHandle``` реализует класс [**SafeHandleZeroOrMinusOneIsInvalid**][links]

```UsbPortsReader``` осуществляет чтение свойств устройств

## Spec

Классы спецификации, которые позволяют понять, относится ли то или иное устройство к той или иной категории (```DeviceFromHubSpec``` - определяет подключено устройство через хаб,  ```NeededDeviceSpec``` - можно ли утсройство считать нужным[^4], ```OtherDeviceSpec``` - можно ли считать утсройство не нужным)

## Translators

```DeviceChangesTranslator``` полчает lParam от хука и возвращает hardwareId (на этом уровне это называется путём к устройству, так как большинство hardwareId вместо id, предположительно, шифруют путь к устройству)

## Utils

```DelayEraser``` вызывается, когда какое-то устройство было помечено на удаление, и дёргает метода по удалению устройств с данной меткой

```LogWorker``` класс собирающий логгер, если в решении уже используется NLog не закомментируйсте метод ```ConfigNLog```

## Converters

```DeviceConverter``` наполняет устройство из свойств, что были переданы (важно передавать группированные по короткому пути, чтобы извлечь максимальную пользу и не допустить ошибок). Не стоит вызывать в случаях, когда не уверен, что все свойства относятся к одному устройству

## Models

Все классы в этой папке используется исключительно для виндовых библиотек, эти классы изменять **НЕЛЬЗЯ** ни при каких условиях! _~~(можно добавлять новые классы)~~_

## CLibs

Содержит в себе всё связанное с библиотеками, для работы используются библиотеки User32.dll, SetupApi.dll, AdvApi.dll. На каждую библиотеку создан одноимённый класс, каждый из которых является обвесом для библиотеки. Их задача скрыть лишнее от внешних классов. Каждый класс имеет подробное описание каждоuо метода на [Pinvoke][links]

```LibrariesConstants``` создержит в себе константы для библиотек

```LibrariesWorker``` объединяет 2 библиотеки (AdvApi и SetupApi) для получения COM порта устройства. Если в дальнейшем можно будет как-то заставить бибилотеки работать из-под одного класса, это должен быть он.

## CLibs/Enums

Содержить в себе все перечисления для библиотек, нельзя именять уже существующие, но можно добавлять новые.

[^1]: [Смотри термин "свойства"][term]
[^2]: [Смотри термин "устройство"][term]
[^3]: [Смотри термин "хаб"][term]
[^4]: [Смотри термин "нужные устройства"][term]

[mainreadme]: ../README.md
[example]: ../README.md#Примеры
[deviceexample]: ../README.md#Девайс
[propertiesexample]: ../README.md#Свойства
[term]: ../README.md#Термины
[links]: ../README.md#Полезные-ссылки